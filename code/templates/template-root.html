{% extends "template.html" %}

{# custom css #}
{% block css %}
    <link rel="stylesheet" href="{{-script_root-}}/static/css/bootstrap-table.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}

{% block nav_home %}
    active
{% endblock %}

{#{% block date_range_picker %}#}
{#{% endblock %}#}

{% block body %}

    <div class="container">
        <div class="row mb-2">
            <div class="col-md-8 mb-2">
                <h3>White dwarfs detected with ZTF</h3>
            </div>
            <div class="col-md-4">
                <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
                <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

                <div id="reportrange" class="text-right w-100"
                     style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;">
                    <i class="far fa-calendar-alt"></i>&nbsp;
                    <span></span> <i class="fas fa-caret-down"></i>
                </div>

                <script type="text/javascript">
                $(function() {

                    {#var start = moment().utc().subtract(1, 'days').startOf('day');#}
                    var start = moment().utc().startOf('day');
                    var end = moment().utc();

                    function cb(start, end) {
                        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                    }

                    $('#reportrange').daterangepicker({
                        startDate: start,
                        endDate: end,
                        minDate: moment('20170901', 'YYYYMMDD'),
                        maxDate: end,
                        opens: "left",
                        ranges: {
                           'Today': [moment().utc().startOf('day'), moment().utc().add(1, 'days').startOf('day')],
                           'Yesterday': [moment().utc().subtract(1, 'days').startOf('day'),
                                         moment().utc().startOf('day')],
                           'Last 7 Days': [moment().utc().subtract(6, 'days').startOf('day'),
                                           moment().utc().add(1, 'days').startOf('day')],
                           'Last 30 Days': [moment().utc().subtract(29, 'days').startOf('day'),
                                            moment().utc().add(1, 'days').startOf('day')],
                           'This Month': [moment().utc().startOf('month'),
                                          moment().utc().endOf('month')],
                           'Last Month': [moment().utc().subtract(1, 'month').startOf('month'),
                                          moment().utc().subtract(1, 'month').endOf('month')],
                           'Everything': [moment('20170901', 'YYYYMMDD'), moment().utc()]
                        }
                    }, cb);

                    cb(start, end);

                    $('#reportrange').on('apply.daterangepicker', function(ev, picker) {
                        var start = picker.startDate.format('YYYYMMDD');
                        var end = picker.endDate.format('YYYYMMDD');
                        window.location.href = "?start=" + start + "&end=" + end;
                    });

                });
                </script>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
            </div>
        </div>

        <div id="toolbar" class="btn-group">
                <button type="button" class="btn btn-outline-dark"
                        style="cursor: pointer;" onclick="expand_all()">
                    <i class="fas fa-plus" aria-hidden="true"></i>
                </button>
            </div>
            <table id="table"
                   class="table table-hover table-condensed"
                   data-toggle="table"
                   data-toolbar="#toolbar"
                   data-pagination="true"
                   data-side-pagination="client"
                   data-minimum-count-columns="2"
                   data-page-size="25"
                   data-page-list="[25, 50, 100, 200, 500, All]"
                   data-search="true"
                   data-detail-view="true"
                   data-detail-formatter="detailFormatter"
                   data-show-columns="true"
                   data-show-export="true"
                   data-export-types="['json', 'csv']"
                   data-export-options='{ "fileName": "alerts-wd",
                                          "worksheetName": "alerts-wd1"
                                         }'>
                <thead>
                <tr>
{#                    <th data-field="state" data-checkbox="true"></th>#}
                    <th data-sortable="true" data-sorter="stringSorter"
                        data-field="id">query id</th>
                    <th data-sortable="true" data-sorter="stringSorter"
                        data-field="query_created">date created, UTC</th>
                    <th data-sortable="true" data-sorter="stringSorter" data-visible="false"
                        data-field="query_last_modified">date last modified, UTC</th>
                    <th data-sortable="true" data-sorter="stringSorter"
                        data-field="query_expires">date expires, UTC</th>
                    <th data-sortable="true" data-sorter="stringSorter"
                        data-field="query_status">status</th>
                    <th data-field="query_actions">actions</th>
                </tr>
                </thead>
                <tbody id="table-tbody">
                {% for query in user_tasks %}
                    {% set query_id = query['task_id'] %}
                    <tr class="clickable-row" data-uniqueid="{{ query_id }}" id="{{ query_id }}">
{#                        <td></td>#}
                        <td>{{ query_id }}</td>
                        {% for key in ('created', 'last_modified', 'expires')%}
                            <td id="{{ query_id }}-{{ key }}">
                                {{ query[key].strftime('%Y-%m-%d %H:%M:%S') }}
                            </td>
                        {% endfor %}
                        <td id="{{ query_id }}-status">
                            {% if query["status"] == "done" %}
                                {% set query_status = 'success' %}
                            {% endif %}
                            {% if query["status"] == "failed" %}
                                {% set query_status = 'danger' %}
                            {% endif %}
                            {% if query["status"] == "enqueued" %}
                                {% set query_status = 'warning' %}
                            {% endif %}
                            <span class="badge badge-{{ query_status }}">{{ query["status"] }}</span>
                        </td>
                        <td id="{{ query_id }}-actions">
                            {# remove if not enqueued #}
                            {% if query["status"] != "enqueued" %}

                                <a href="#" class="text-danger"
                                   onclick="remove_query('{{ query_id }}')"
                                   data-toggle="tooltip" data-placement="top" title="Remove query"><i class="fa fa-trash" aria-hidden="true"></i></a>
                            {% endif %}
                            {# download query #}
                            |
                            <a href="#" onclick="get_query('{{ query_id }}')"
                               data-toggle="tooltip" data-placement="top" title="Get query"><i class="fa fa-tasks" aria-hidden="true"></i></a>
                            <a href="#" onclick="get_query_view('{{ query_id }}')"
                               data-toggle="tooltip" data-placement="top" title="View query in browser"><i class="fa fa-eye" aria-hidden="true"></i></a>
                            {# download result #}
                            {% if query["status"] in ["done", "failed"] %}
                                |
                                <a download="{{ query_id }}.result.json" href="/data/{{ user }}/{{ query_id }}.result.json"
                                   data-toggle="tooltip" data-placement="top" title="Get result"><i class="fa fa-download" aria-hidden="true"></i></a>
                                <a href="#" onclick="get_query_result_view('{{ query_id }}')"
                                   data-toggle="tooltip" data-placement="top" title="View result in browser"><i class="fa fa-eye" aria-hidden="true"></i></a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

{#        <div class="row mb-2">#}
{#            <div class="col-12">#}
{#                {% for alert in alerts %}#}
{#                    {{  alert['_id'] }}<br>#}
{#                    {% for cutout in ('science.jpg', 'template.jpg', 'difference.jpg') %}#}
{#                        <img src="/data/{{alert['_id']}}/{{cutout}}" class="mr-1 mb-1">#}
{#                    {% endfor %}#}
{#                    <hr>#}
{#                {% endfor %}#}
{#            </div>#}
{#        </div>#}
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modal" tabindex="-1" role="dialog"
         aria-labelledby="modal-query-id" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-query-id"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modal-body">
                    <pre><code id="modal-body-code" style="font-size:0.75em;"></code></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
{#                    <button type="button" class="btn btn-primary">Save changes</button>#}
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
    <!-- Bootstrap table -->
    <script src="{{-script_root-}}/static/js/bootstrap-table.js"></script>
    <script src="{{-script_root-}}/static/js/bootstrap-table-en-US.js"></script>
    <script src="{{-script_root-}}/static/js/tableExport.js"></script>
    <script src="{{-script_root-}}/static/js/bootstrap-table-export.js"></script>
    <script src="{{-script_root-}}/static/js/FileSaver.min.js"></script>

    <!-- Big int support for js -->
    <script src="{{-script_root-}}/static/js/json-bigint.js"></script>

    <script>
        // Fancy table stuff
        function getHeight() {
            var window_height = $(window).height();
            if (window_height > 1200) {
                var top = document.getElementById('table').getBoundingClientRect().top;
                return Math.max(400, window_height - top - 10);
            }
            else {
                return Math.max(400, window_height - 210);
            }
        }
        // reset height of table with search results
        function resetTableHeight() {
            var $table = $('#table');
            $table.bootstrapTable('resetView', {
                height: getHeight()
            });
        }
        $(document).ready(function() {
            // on load
            if( $('#table').length ) {
                resetTableHeight();
            }
        });
        $(window).resize(function () {
            // on window resize
            if( $('#table').length ) {
                resetTableHeight();
            }
        });

        {# table sorting #}
        function getOrder() {
            var $table = $('#table');
            return $table.bootstrapTable('getOptions').sortOrder === 'asc' ? -1 : 1;
        }

        function numberSorter(a, b) {
            a = $.trim(a.replace(/<\/?[^>]+(>|$)/g, ""));
            b = $.trim(b.replace(/<\/?[^>]+(>|$)/g, ""));
            if (!a || a === 'None') return -1 * getOrder();
            if (!b || b === 'None') return 1 * getOrder();
            if (parseFloat(a) < parseFloat(b)) return -1;
            if (parseFloat(a) > parseFloat(b)) return 1;
            return 0;
        }

        function stringSorter(a, b) {
            a = $.trim(a.replace(/<\/?[^>]+(>|$)/g, ""));
            b = $.trim(b.replace(/<\/?[^>]+(>|$)/g, ""));
            if (!a || a === 'None') return -1 * getOrder();
            if (!b || b === 'None') return 1 * getOrder();
            if (a < b) return -1;
            if (a > b) return 1;
            return 0;
        }

        {# expand all rows in table #}
        function expand_all(){

        }


        {# init tooltips #}
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });


        {# actions #}
        {# download json as files #}
        function download(json, name, type) {
            var a = document.createElement("a");
            var file = new Blob([json], {type: type});
            var url = URL.createObjectURL(file);
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            setTimeout(function(){
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }


        {# show flashing messages #}
        function showFlashingMessage(title, message, type) {
            $.notify({title: title, message: message},
                {placement: {
                    from: "bottom",
                    align: "right"
                },
                    type: type,
                    template: '<div data-notify="container" class="col-xs-11 col-sm-3 alert alert-{0}" role="alert" ' +
                    'style="max-width:400px; font-size: 0.75rem;">' +
                    '<button type="button" aria-hidden="true" class="close" data-notify="dismiss">×</button>' +
                    '<span data-notify="icon"></span> ' +
                    '<span data-notify="title">{1}</span> ' +
                    '<span data-notify="message">{2}</span>' +
                    '<div class="progress" data-notify="progressbar">' +
                    '<div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" ' +
                    'aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +
                    '</div>' +
                    '<a href="{3}" target="{4}" data-notify="url"></a>' +
                    '</div>'
            });
        }
    </script>

    {# propagate date ranges #}
    {% if request.args.get('start') != None and request.args.get('end') != None %}
    <script>
        $(document).ready(function() {
            var start = moment('{{request.args.get('start')}}', 'YYYYMMDD');
            var end = moment('{{request.args.get('end')}}', 'YYYYMMDD');

            $('#reportrange').data('daterangepicker').setStartDate(start);
            $('#reportrange').data('daterangepicker').setEndDate(end);
            $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
        });
    </script>
    {% endif %}
{% endblock %}